<h2>Lista de Productos</h2>

{{#if products}}
    <div id="productsList" class="products-grid">
        {{#each products}}
        <div class="product-card" data-id="{{this.id}}">
            {{#if this.thumbnails}}
                <div class="product-image-container" data-product-id="{{this.id}}">
                    {{#each this.thumbnails}}
                        {{#if this}}
                            <img src="{{this}}" alt="{{../title}}" class="product-image {{#if @first}}active{{/if}}" data-product-id="{{../id}}" onerror="this.style.display='none'">
                        {{/if}}
                    {{/each}}
                </div>
            {{else}}
                <div class="product-image-placeholder">Sin imagen</div>
            {{/if}}
            <h3>{{this.title}}</h3>
            <p><strong>Descripción:</strong> {{this.description}}</p>
            <p class="product-price">${{this.price}}</p>
            <p class="product-stock">Stock: {{this.stock}}</p>
            <p><strong>Categoría:</strong> {{this.category}}</p>
        </div>
        {{/each}}
    </div>
{{else}}
    <div id="productsList" class="products-grid"></div>
    <div class="empty-state">
        <p>No hay productos disponibles</p>
    </div>
{{/if}}

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();

    // Función helper para renderizar imágenes con carrusel
    function renderImages(thumbnails, productId) {
        if (!thumbnails || thumbnails.length === 0) {
            return '<div class="product-image-placeholder">Imagen no disponible</div>';
        }
        const imagesHtml = thumbnails.map((img, index) => 
            img ? `<img src="${img}" alt="Producto" class="product-image ${index === 0 ? 'active' : ''}" data-product-id="${productId}" onerror="this.style.display='none'">` : ''
        ).join('');
        return `<div class="product-image-container" data-product-id="${productId}">${imagesHtml}</div>`;
    }

    // Función helper para crear tarjeta de producto
    function createProductCard(product) {
        return `
            <div class="product-card" data-id="${product.id}">
                ${renderImages(product.thumbnails, product.id)}
                <h3>${product.title}</h3>
                <p><strong>Descripción:</strong> ${product.description}</p>
                <p class="product-price">$${product.price}</p>
                <p class="product-stock">Stock: ${product.stock}</p>
                <p><strong>Categoría:</strong> ${product.category}</p>
            </div>
        `;
    }

    // Escuchar cuando se agrega un producto
    socket.on("productAdded", (product) => {
        console.log("Producto recibido en home:", product);
        const productsList = document.getElementById("productsList");
        if (!productsList) {
            console.error("No se encontró productsList");
            return;
        }
        
        //esto para sacar el mensaje de no hay productos disponibles
        const emptyState = document.querySelector(".empty-state");
        if (emptyState) {
            emptyState.remove();
        }
        
        //esto para agregar el producto a la lista al final
        productsList.insertAdjacentHTML("beforeend", createProductCard(product));
        //carrusel para este producto
        startImageCarousel(product.id);
    });

    // Escuchar cuando se elimina un producto
    socket.on("productDeleted", (productId) => {
        const productCard = document.querySelector(`[data-id="${productId}"]`);
        if (productCard) {
            productCard.remove();
            
            // Si no hay más productos, mostrar mensaje vacío
            const productsList = document.getElementById("productsList");
            if (productsList.children.length === 0) {
                productsList.insertAdjacentHTML("afterend", '<div class="empty-state"><p>No hay productos disponibles</p></div>');
            }
        }
    });

    // Escuchar cuando se actualiza un producto
    socket.on("productUpdated", (product) => {
        const productCard = document.querySelector(`[data-id="${product.id}"]`);
        if (productCard) {
            productCard.outerHTML = createProductCard(product);
            // Reiniciar carrusel
            startImageCarousel(product.id);
        }
    });

    // Función para iniciar carrusel de imágenes
    function startImageCarousel(productId) {
        const container = document.querySelector(`.product-image-container[data-product-id="${productId}"]`);
        if (!container) return;
        
        const images = container.querySelectorAll('.product-image');
        if (images.length <= 1) return; // No necesita carrusel si hay 1 o menos imágenes
        
        let currentIndex = 0;
        
        setInterval(() => {
            images[currentIndex].classList.remove('active');
            currentIndex = (currentIndex + 1) % images.length;
            images[currentIndex].classList.add('active');
        }, 3000);
    }

    // Iniciar carruseles para productos existentes al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        const allContainers = document.querySelectorAll('.product-image-container');
        allContainers.forEach(container => {
            const productId = container.getAttribute('data-product-id');
            if (productId) {
                startImageCarousel(productId);
            }
        });
    });

    // desconectar al salir de la página
    window.addEventListener("beforeunload", () => {
        socket.disconnect();
    });
</script>

